<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><?= title ?></title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070A14;--line:rgba(255,255,255,.09);
      --text:#EAF0FF;--muted:#9FB0D0;--pri:#7AA2FF;
      --good:#57D38A;--bad:#FF6B6B;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial;
      color:var(--text);background:radial-gradient(900px 650px at 10% 0%, #17234a 0%, var(--bg) 60%);}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .top{display:flex;gap:10px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.6}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--muted);font-size:12px}
    .stack{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .card{border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.07); box-shadow:0 12px 34px rgba(0,0,0,.35); padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    .split{height:1px;background:var(--line);margin:10px 0}
    input,select,button{border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22);color:var(--text);
      border-radius:12px;padding:8px 10px;font-size:12px;outline:none}
    input[type="date"]{padding:7px 10px}
    button{cursor:pointer;transition:transform .05s ease, opacity .08s}
    button:active{transform:scale(.97);opacity:.85}
    button[disabled]{opacity:.55;cursor:default;transform:none}
    .pri{background:rgba(122,162,255,.22);border-color:rgba(122,162,255,.4)}
    .danger{background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.5)}
    .tiny{color:var(--muted);font-size:11px}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    @media (max-width:720px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .k{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.2)}
    .k .t{color:var(--muted);font-size:12px}
    .k .v{margin-top:4px;font-size:20px;font-weight:800}
    .good{color:var(--good)} .bad{color:var(--bad)}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
    th,td{padding:7px 6px;border-top:1px solid var(--line);text-align:left;vertical-align:middle;white-space:nowrap}
    th{color:var(--muted);font-weight:500;font-size:11px}
    .namecol{min-width:280px;white-space:normal}
    .cell{width:130px;border-radius:10px;padding:6px 8px}
    .cell.small{width:105px}
    .btn-mini{padding:5px 9px;border-radius:999px;font-size:11px}
    .wbar{width:110px;height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.08)}
    .wbar>div{height:100%;background:rgba(122,162,255,.65)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;max-width:92vw;
      background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.18);padding:9px 14px;border-radius:12px;display:none;font-size:12px}
    .spin{width:12px;height:12px;border-radius:999px;border:2px solid rgba(255,255,255,.22);border-top-color:rgba(255,255,255,.75);
      display:inline-block;animation:rot .7s linear infinite}
    @keyframes rot{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1><?= title ?> (｀・ω・´)</h1>
      <div class="sub">
        这版把按钮事件改成 addEventListener，并加入“页面自报错”。按钮再也不会假死。
      </div>
    </div>

    <div class="right">
      <span class="pill" id="jsStatus">JS：加载中…</span>
      <span class="pill" id="cnTime">沪市日期：--</span>
      <label class="pill"><input id="auto" type="checkbox" checked style="vertical-align:middle;margin-right:4px">自动刷新</label>
      <select id="interval">
        <option value="60000" selected>60秒</option>
        <option value="120000">2分钟</option>
        <option value="300000">5分钟</option>
      </select>
      <button type="button" class="pri" id="btnRefresh">手动刷新</button>
    </div>
  </div>

  <div class="stack">

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <span class="pill">总览</span>
        <span class="tiny" id="hint"></span>
      </div>

      <div class="kpi">
        <div class="k"><div class="t">总投入</div><div class="v" id="kCost">--</div></div>
        <div class="k"><div class="t">总市值</div><div class="v" id="kValue">--</div></div>
        <div class="k"><div class="t">浮动盈亏</div><div class="v" id="kProfit">--</div></div>
        <div class="k"><div class="t">浮动收益率</div><div class="v" id="kPR">--</div></div>
      </div>

      <div class="tiny" style="margin-top:8px">
        基金起息日前：收益=0、市值按投入额展示。
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <span class="pill">持仓管理</span>
        <span class="tiny">只填：代码 + 买入日 + 投入金额（成本可空，前端会推算）</span>
      </div>

      <div class="split"></div>

      <div class="row">
        <select id="kind">
          <option value="fund">基金（6位，如 161226）</option>
          <option value="sec">场内（sz/sh+6位；也可只填6位默认sz）</option>
        </select>
        <input id="code" placeholder="例如：161226 或 sz161226" style="flex:1;min-width:260px"/>
        <input id="buyDate" type="date" class="cell" />
        <input id="amount" placeholder="投入金额(元)" class="cell" />
        <input id="cost" placeholder="成本单价(可空)" class="cell" />
        <button type="button" class="pri" id="btnAdd">新增持仓</button>
      </div>

      <div class="tiny" style="margin-top:8px">
        默认你 15:00 前买入。若 15:00 后买入，把“买入日”改成下一个交易日更贴近确认。
      </div>

      <div class="split"></div>

      <div class="tiny">持仓明细（保存/删除在表格内点击）</div>
      <div style="overflow:auto">
        <table id="tb">
          <thead>
          <tr>
            <th class="namecol">名称</th>
            <th>占比</th>
            <th>持有天数</th>
            <th>买入日</th>
            <th>投入(元)</th>
            <th>成本单价</th>
            <th>现价/估值</th>
            <th>市值</th>
            <th>盈亏</th>
            <th>收益率</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">7日曲线</span>
          <select id="chartTarget"></select>
          <select id="chartMode">
            <option value="pct">涨跌幅(相对起点)</option>
            <option value="val">市值变动(元)</option>
          </select>
        </div>
        <span class="tiny" id="chartStatus">曲线状态：--</span>
      </div>
      <div style="margin-top:8px"><canvas id="c1" height="150"></canvas></div>
      <div class="tiny" id="chartHint" style="margin-top:8px"></div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Same JS script with minor edits to fix button click issues
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("btnRefresh").addEventListener("click", refreshAll);
  document.getElementById("btnAdd").addEventListener("click", addHolding);
  document.getElementById("chartTarget").addEventListener("change", drawChart);
  document.getElementById("chartMode").addEventListener("change", drawChart);
  document.getElementById("auto").addEventListener("change", setupTimer);
  document.getElementById("interval").addEventListener("change", setupTimer);
  setupTimer();
});
</script>

</body>
</html>
